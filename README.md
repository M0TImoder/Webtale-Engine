# Webtale-Engine

Webブラウザを使用して自由にカスタマイズ可能なUndertale風の戦闘を楽しめるソフトウェアです。本プロジェクトはTobyFox氏および本家Undertaleとは一切の関係がありません。

## 弾幕エンジン設計レビュー（Rust + Bevy ECS）

### 1. ECS設計として破綻する可能性
- **同一Transformへの複数書き込みが順序依存になる**  
  例: LinearMotion と CircularMotion を同時に持つ弾があると、両SystemがTransformを更新するため、システム順序で結果が変わります。挙動合成を意図していても、現在設計だと非決定的なズレや見た目の揺れが起きます。
- **挙動終了時のComponent削除によるアーキタイプスラッシング**  
  例: 1000〜3000発の弾が同時に「Bezier終了」すると、同フレームで大量のComponent削除が発生し、ECSのアーキタイプスラッシングが一気に起きてフレーム落ちが出る可能性があります。
- **挙動合成が増えるほどSystemの競合が指数的に増える**  
  例: 3種類の挙動を任意組合せで付けると、相互作用の組合せが増え、System順序や競合解消のための専用ロジックが必要になり破綻しやすいです。

### 2. キャッシュ効率・メモリアクセスの懸念
- **同一弾を複数Systemが個別に走査**  
  各MotionごとにQueryが回るため、同じ弾に対して複数回メモリアクセスが走ります。弾数が1000〜3000発でMotion種類が増えると「弾数 × Motion数」の走査になり、キャッシュ効率が悪化します。
- **Component削除による局所性の崩れ**  
  弾の寿命に合わせて頻繁にComponentを外す運用は、同型弾が連続配置されにくくなり、キャッシュヒット率が低下します。

### 3. 弾の種類が爆発的に増えた場合の問題
- **Systemの増殖とスケジューリング複雑化**  
  Motionが増えるたびにSystemを増やすと、依存順序の管理が困難になります。順序の差異が挙動に影響するため、保守コストが年々増えます。
- **データ定義の組合せ爆発**  
  「Linear + Circular + Bezier + ...」の組合せが増えると、挙動検証とバグ再現が難しくなり、設計が破綻しやすいです。

### 4. Python側との責務分離が適切か
- **初期データ定義のみなら妥当。ただしRust側に正規化が必須**  
  Pythonで定義した弾データをロード時にRust構造体へ変換し、フレーム更新はRust側で完結させる必要があります。そうしないと、Python参照が残り続けてGCやGILがボトルネックになります。
- **実運用で「少しだけPython更新」が混ざると破綻**  
  例: デザイナがPythonに軽微な更新処理を足し始めると、GILやPyObjectアクセスが1フレーム数千回発生し、設計意図が崩れます。

### 5. 代替設計（具体案）
- **Motionを単一Componentに集約するデータ駆動方式**  
  `Motion { kind: MotionKind, params: MotionParams, elapsed: f32 }` のようにし、1つのSystemで更新する。挙動合成は `Vec<MotionStep>` として処理順序を明示し、System競合を排除。
- **Velocity / Accelベースの統合Kinematics**  
  Transform更新を1回にまとめ、Linear/Circular/Bezierは「速度・加速度・曲率」を生成するデータとして扱う。
- **BulletBatch / SoA専用コンテナ**  
  弾が大量の場合はECS外に専用バッファを持ち、位置・速度・状態をSoAで連続配置する。Bevy側は描画だけ担当。

### 破綻する具体的シナリオ
1. **ボス戦で1000〜3000発が同時にBezier終了** → Component削除が集中し、フレームタイムが急増。
2. **Linear + Circularの弾が毎フレーム振動** → System順序で位置が揺らぎ、デバッグ不能なズレが発生。
3. **Motion追加が10種類を超える** → System順序管理が崩壊し、設計者以外が挙動を理解できなくなる。

### 数年後に技術的負債になり得る部分
- Motion数増加に伴うSystem順序依存とバグ再現性の悪化
- Component削除によるアーキタイプスラッシングのフレーム落ち
- PythonデータがRustに正規化されない場合のGIL/GC負債
- 挙動合成が暗黙的になり、デザイナとエンジニアの責任境界が崩れる
